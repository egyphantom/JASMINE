<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة منتج جديد</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            direction: rtl;
            text-align: right;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 400px;
            max-width: 90%;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .qr-scanner-section {
            text-align: center;
            margin-bottom: 20px;
        }
        #qr-video {
            width: 100%;
            max-width: 300px;
            height: 250px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 10px;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background-color: #218838;
        }
        #statusMessage {
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>إضافة منتج جديد</h2>

        <div class="qr-scanner-section">
            <button id="startScannerBtn">بدء مسح الكيو آر / الباركود</button>
            <!-- استبدلنا الفيديو بـ div -->
            <div id="qr-video" style="display:none;"></div>
            <p id="qr-scan-result" style="font-weight: bold; color: #007bff; margin-top: 10px;"></p>
        </div>

        <form id="productForm">
            <div class="form-group">
                <label for="barcode">الباركود / الكيو آر:</label>
                <input type="text" id="barcode" readonly required>
                <div id="barcodeError" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="productName">اسم المنتج:</label>
                <input type="text" id="productName" required>
                <div id="productNameError" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="scientificName">الاسم العلمي (اختياري):</label>
                <input type="text" id="scientificName">
            </div>
            <div class="form-group">
                <label for="quantity">الكمية:</label>
                <input type="number" id="quantity" min="1" required>
                <div id="quantityError" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="purchasePrice">سعر الشراء:</label>
                <input type="number" id="purchasePrice" step="0.01" required>
                <div id="purchasePriceError" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="salePrice">سعر البيع:</label>
                <input type="number" id="salePrice" step="0.01" required>
                <div id="salePriceError" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="expiryDate">تاريخ الانتهاء:</label>
                <input type="date" id="expiryDate">
                <div id="expiryDateError" class="error-message"></div>
            </div>
            <div class="form-group">
                <label for="supplier">المورد (اختياري):</label>
                <input type="text" id="supplier">
            </div>
            <div class="form-group">
                <label for="description">وصف المنتج (اختياري):</label>
                <textarea id="description" rows="3"></textarea>
            </div>
            <button type="submit">إضافة المنتج</button>
        </form>
        <p id="statusMessage"></p>
    </div>

    <!-- مكتبة Html5Qrcode لازم تكون قبل كودك -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
        import { getFirestore, doc, getDoc, runTransaction, FieldValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5ls-rPdJ65x5BoMGwAOpdcPtD585C2ys",
            authDomain: "pharmacy-inventory-bf04a.firebaseapp.com",
            projectId: "pharmacy-inventory-bf04a",
            storageBucket: "pharmacy-inventory-bf04a.firebasestorage.app",
            messagingSenderId: "937788650384",
            appId: "1:937788650384:web:6451225d00e648f3a0b915",
            measurementId: "G-ZGC9EQ55SL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const startScannerBtn = document.getElementById('startScannerBtn');
        const qrVideo = document.getElementById('qr-video');
        const qrScanResult = document.getElementById('qr-scan-result');
        const productForm = document.getElementById('productForm');
        const barcodeInput = document.getElementById('barcode');
        const productNameInput = document.getElementById('productName');
        const quantityInput = document.getElementById('quantity');
        const purchasePriceInput = document.getElementById('purchasePrice');
        const salePriceInput = document.getElementById('salePrice');
        const expiryDateInput = document.getElementById('expiryDate');
        const statusMessage = document.getElementById('statusMessage');

        const barcodeError = document.getElementById('barcodeError');
        const productNameError = document.getElementById('productNameError');
        const quantityError = document.getElementById('quantityError');
        const purchasePriceError = document.getElementById('purchasePriceError');
        const salePriceError = document.getElementById('salePriceError');
        const expiryDateError = document.getElementById('expiryDateError');

        let html5QrCode;

        // بدء تشغيل الماسح
        startScannerBtn.addEventListener('click', () => {
            qrVideo.style.display = 'block';
            startScannerBtn.style.display = 'none';

            html5QrCode = new Html5Qrcode("qr-video");
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    const cameraId = devices.find(device => device.label.toLowerCase().includes('back'))?.id || devices[0].id;
                    html5QrCode.start(
                        cameraId,
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            qrScanResult.textContent = `تم مسح: ${decodedText}`;
                            barcodeInput.value = decodedText;
                            barcodeInput.disabled = true;

                            html5QrCode.stop().then(() => {
                                qrVideo.style.display = 'none';
                                startScannerBtn.style.display = 'block';
                            });

                            checkProductExistence(decodedText);
                        }
                    ).catch(err => {
                        console.error("Unable to start scanning: ", err);
                        qrScanResult.textContent = "خطأ في بدء تشغيل الكاميرا. تأكد من إعطاء الصلاحية.";
                        qrScanResult.classList.add('error');
                    });
                } else {
                    qrScanResult.textContent = "لم يتم العثور على أي كاميرات.";
                    qrScanResult.classList.add('error');
                }
            }).catch(err => {
                console.error("Error getting camera devices: ", err);
                qrScanResult.textContent = "خطأ في الوصول إلى الكاميرا. (تأكد من استخدام HTTPS)";
                qrScanResult.classList.add('error');
            });
        });

        // تحقق من وجود المنتج
        async function checkProductExistence(barcode) {
            try {
                const productRef = doc(db, 'products', barcode);
                const docSnap = await getDoc(productRef);

                if (docSnap.exists()) {
                    const productData = docSnap.data();
                    productNameInput.value = productData.name;
                    productNameInput.disabled = true;
                    document.getElementById('scientificName').value = productData.scientificName || '';
                    purchasePriceInput.value = productData.purchasePrice;
                    salePriceInput.value = productData.salePrice;
                    document.getElementById('supplier').value = productData.supplier || '';
                    document.getElementById('description').value = productData.description || '';

                    quantityInput.value = '';
                    expiryDateInput.value = '';

                    statusMessage.textContent = 'المنتج موجود بالفعل. أدخل الكمية وتاريخ الصلاحية الجديدة.';
                    statusMessage.className = 'statusMessage success';
                } else {
                    productNameInput.value = '';
                    productNameInput.disabled = false;
                    document.getElementById('scientificName').value = '';
                    quantityInput.value = '';
                    purchasePriceInput.value = '';
                    salePriceInput.value = '';
                    expiryDateInput.value = '';
                    document.getElementById('supplier').value = '';
                    document.getElementById('description').value = '';

                    statusMessage.textContent = 'المنتج جديد. يرجى إدخال جميع التفاصيل.';
                    statusMessage.className = 'statusMessage';
                }
            } catch (error) {
                console.error("Error checking product existence: ", error);
                statusMessage.textContent = 'خطأ أثناء التحقق من المنتج.';
                statusMessage.className = 'statusMessage error';
            }
        }

        // إرسال البيانات
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            statusMessage.textContent = '';
            statusMessage.classList.remove('success', 'error');

            barcodeError.textContent = '';
            productNameError.textContent = '';
            quantityError.textContent = '';
            purchasePriceError.textContent = '';
            salePriceError.textContent = '';
            expiryDateError.textContent = '';

            let isValid = true;
            if (!barcodeInput.value) {
                barcodeError.textContent = 'الباركود مطلوب.';
                isValid = false;
            }
            if (!productNameInput.value) {
                productNameError.textContent = 'اسم المنتج مطلوب.';
                isValid = false;
            }
            if (quantityInput.value <= 0 || isNaN(quantityInput.value)) {
                quantityError.textContent = 'الكمية يجب أن تكون أكبر من صفر.';
                isValid = false;
            }
            if (purchasePriceInput.value <= 0 || isNaN(purchasePriceInput.value)) {
                purchasePriceError.textContent = 'سعر الشراء مطلوب ويجب أن يكون أكبر من صفر.';
                isValid = false;
            }
            if (salePriceInput.value <= 0 || isNaN(salePriceInput.value)) {
                salePriceError.textContent = 'سعر البيع مطلوب ويجب أن يكون أكبر من صفر.';
                isValid = false;
            }
            if (!expiryDateInput.value) {
                expiryDateError.textContent = 'تاريخ الانتهاء مطلوب.';
                isValid = false;
            }

            if (!isValid) {
                statusMessage.textContent = 'يرجى تصحيح الأخطاء في النموذج.';
                statusMessage.classList.add('error');
                return;
            }

            const productBarcode = barcodeInput.value;
            const productName = productNameInput.value;
            const scientificName = document.getElementById('scientificName').value;
            const quantity = parseInt(quantityInput.value);
            const purchasePrice = parseFloat(purchasePriceInput.value);
            const salePrice = parseFloat(salePriceInput.value);
            const expiryDate = expiryDateInput.value;
            const supplier = document.getElementById('supplier').value;
            const description = document.getElementById('description').value;

            try {
                const productRef = doc(db, 'products', productBarcode);

                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(productRef);

                    if (!docSnap.exists()) {
                        transaction.set(productRef, {
                            barcode: productBarcode,
                            name: productName,
                            scientificName: scientificName,
                            purchasePrice: purchasePrice,
                            salePrice: salePrice,
                            supplier: supplier,
                            description: description,
                            createdAt: serverTimestamp(),
                            lastUpdated: serverTimestamp(),
                            batches: []
                        });
                    } else {
                        transaction.update(productRef, {
                            name: productName,
                            scientificName: scientificName,
                            purchasePrice: purchasePrice,
                            salePrice: salePrice,
                            supplier: supplier,
                            description: description,
                            lastUpdated: serverTimestamp(),
                        });
                    }

                    const newBatch = {
                        batchId: Date.now().toString(),
                        quantity: quantity,
                        expiryDate: expiryDate,
                        receivedAt: serverTimestamp(),
                    };

                    transaction.update(productRef, {
                        batches: FieldValue.arrayUnion(newBatch)
                    });
                });

                statusMessage.textContent = 'تم إضافة/تحديث المنتج بنجاح!';
                statusMessage.classList.add('success');
                productForm.reset();
                barcodeInput.disabled = false;
                productNameInput.disabled = false;
                qrScanResult.textContent = '';
            } catch (error) {
                console.error("Error adding/updating product: ", error);
                statusMessage.textContent = `خطأ في إضافة المنتج: ${error.message}`;
                statusMessage.classList.add('error');
            }
        });

        window.addEventListener('beforeunload', () => {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Error stopping scanner on unload:", err));
            }
        });
    </script>
</body>
</html>
